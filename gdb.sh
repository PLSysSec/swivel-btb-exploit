#!/bin/bash

GDB=gdb
LUCET_WASI=../lucet-spectre/target/release/lucet-wasi
LUCET_WASI_ARGS='--heap-address-space 8GiB --max-heap-size 4GiB --stack-size 8MiB --dir /:/'

if [[ $1 == "leakage" ]]; then
  SO=btb_leakage.so
  GDBSCRIPT=copycode_leakage.gdbcommands
elif [[ $1 == "breakout" ]]; then
  SO=btb_breakout.so
  GDBSCRIPT=copycode_breakout.gdbcommands
else
  echo 'error: First argument should be either "leakage" or "breakout"'
  exit 1
fi

if [[ $2 == "" ]]; then
  echo "error: Requires a second argument, which should be the name of one of the build directories"
  exit 1
elif [ ! -d "./$2" ]; then
  echo "error: Second argument should be the name of one of the build directories"
  exit 1
fi

if [[ $2 == *aslr ]]; then
  ASLR_FLAGS="--spectre-mitigation-aslr"
else
  ASLR_FLAGS=
fi

if [[ $2 == "sfi_full" || $2 == "sfi_aslr" || $2 == "cet_aslr" ]]; then
  MAYBE_ADD_BTB_FLUSHES= -ex "add_btb_flushes"
else
  MAYBE_ADD_BTB_FLUSHES=
fi

taskset -c 1 $GDB \
-ex "set breakpoint pending on" \
-ex "b *(lucet_context_bootstrap+49)" \
-ex "r" \
-x $GDBSCRIPT \
$MAYBE_ADD_BTB_FLUSHES \
--args $LUCET_WASI $LUCET_WASI_ARGS $ASLR_FLAGS ./$2/$SO
